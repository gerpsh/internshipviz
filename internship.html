<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/topojson.v1.min.js"></script>
	<script src="js/queue.v1.min.js"></script>
	<script src="js/internship_data.js"></script>
	<script src='js/jquery.tipsy.js'></script>
	<link rel="stylesheet" type="text/css" href="css/internship.css">
	<link rel="stylesheet" href="css/tipsy.css" type="text/css">
<head>
<body>
	<div class="toggle-btn-grp">
    <label onclick="projectPoints(allData())" class="toggle-btn"><input id="all-years" type="radio" name="years" value='all years'/>All</label>
    <label onclick="projectPoints(filterYear('2011-12'))" class="toggle-btn"><input type="radio" name="years" value='2011-12'/>2011-12</label>
    <label onclick="projectPoints(filterYear('2012-13'))" class="toggle-btn"><input type="radio" name="years" value='2012-13'/>2012-13</label>
    <label onclick="projectPoints(filterYear('2013-14'))" class="toggle-btn"><input type="radio" name="years" value='2013-14'/>2013-14</label>
	</div>
	<script>

		 $(function() {
   			$('a[rel=tipsy]').tipsy({fade: true, gravity: 'n'});
 		 });

		var width = 800,
			height = 600;
		var projection = d3.geo.albersUsa();
		projection.scale([700]);
		var path = d3.geo.path().projection(projection);

		var x = d3.scale.linear()
    			  .domain([0, width])
    			  .range([0, width]);

		var y = d3.scale.linear()
    			  .domain([0, height])
    			  .range([height, 0]);

        
		var svg = d3.select("body").append("svg")
					.attr("width", width)
					.attr("height", height)
					.attr("id", "map-svg")
					.append("g");

		var panel = d3.select("body").append("svg")
					  .attr("width", width/2)
					  .attr("height", height)
					  .attr("id", "panel-svg");

		var features = svg.append("g");	


		bFill = d3.scale.linear()
					   .domain([0, 59])
					   .range([5, 255]);

		rFill = d3.scale.linear()
				   .domain([0,59])
				   .range([255, 5]);


		/*svg.append("rect")
    	   .attr("class", "overlay")
           .attr("width", width)
           .attr("height", height)
           .call(zoom);*/

        var radius = d3.scale.sqrt()
        			   .domain([1, 199])
        			   .range([4, 10]);

        d3.json("js/us.json", function(error, us) {
  			if (error) return console.error(error);

  			features.append("path")
      				.datum(topojson.feature(us, us.objects.states))
      				.attr("class", "state")
      				.attr("d", path);

  			features.append("path")
      				.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      				.attr("class", "state-border")
      				.attr("d", path)
      				.style("stroke-width", "1.5px");

		});

        //call data synchonously
        //var yearOne = sumData();


        function projectPoints(theData) {
			$(".intern-site").remove();

			var sites = svg.selectAll(".intern-site")
      		   		   .data(theData)
      		           .enter()
      		           .append("circle")
      		           .attr("class", "intern-site")
      		           .attr("cx", function(d) { return projection(d.values.coordinates)[0]; })
      		           .attr("cy", function(d) { return projection(d.values.coordinates)[1]; })
      		           .attr("r", 1)
      		           //.attr("r", function(d) { return radius(d.values.count); })
      		           .style("fill", function(d) {return buildRGB(d.values.medWage);})
      		           .attr("onclick", function(d) { return "displayData('" + d.key + "')" })
      		           .attr("title", function(d) { return d.key })
      		           .transition()
      		           .attr("r", function(d) { return radius(d.values.count); })
      		           .duration(500);

      		$('svg circle').tipsy({ 
        	gravity: 's', 
        	html: true, 
        	title: function() {
          		var d = this.__data__, site = d.key, wage = d.values.medWage, count = d.values.count;
          		return '<span>' + site + '</span><br><span>Median Wage: ' + unpaid(wage) + '</spane><br><span>No. of internships: ' + count + "</span>"; 
        		},
      		});
		}

		function buildRGB(wage) {
        	var b = Math.floor(bFill(wage));
        	var r = Math.floor(rFill(wage));
        	var g = Math.floor(rFill(wage));
        	var rgb = "rgb(" + r.toString() + "," + g.toString() + "," + b.toString() + ")";
        	return rgb;
        }

		function transform(n) {
			console.log(n);
  			return "translate(" + x(n[0]) + "," + y(n[1]) + ")";
		}



		function displayData(location) {


			$("#panel-svg").empty();
			theData = barData(location, $('input[name="years"]:checked').val());

			theData.sort(function(a,b) {
				return b.values.count - a.values.count;
			});

			//console.log(JSON.stringify(theData))
			var barX = d3.scale.linear()
						  .domain([0, theData[0].values.count])
						  .range([5, (width/4) - 70]);

			var barHeight = 30;

			var bar = panel.selectAll("g")
						   .data(theData)
						   .enter().append("g")
						   .attr("transform", function(d, i) { return "translate(0, " + i * barHeight + ")"; })
						   .attr("class", "industry");


			rects = bar.append("rect")
			   		   .attr("height", barHeight-5)
			   		   .attr("width", 0)
			   		   .attr("class", "industry")
			   		   .attr("onclick", function(d) {
			   		   		var industry = d.key;
			   		   		var year = $('input[name="years"]:checked').val();
			   		   		var theString = "projectPoints(filterIndustry('" + industry + "','" + year + "'))";
			   		   		return "console.log(" + theString + "); " + theString;
			   		   })
			   		   //.attr("x", function(d) { return (200 - barX(d.values.count))})
			   		   .transition(500)
			   		   .attr("width", function(d) { return barX(d.values.count) });

			bar.append("text")
			   .attr("y", 15)
			   .attr("class", "bar-text")
			   .attr("x", function(d) { console.log(barX(d.values.count)); return (barX(d.values.count) + 2) })
			   .text(function(d) { return(d.key) });

			
			$('svg rect').tipsy({
        	gravity: 'e', 
        	html: true, 
        	title: function() {
          		var d = this.__data__, industry = d.key, wage = d.values.medWage, count = d.values.count;
          		return '<span>Median Wage: ' + unpaid(wage) + '</spane><br><span>No. of internships: ' + count + "</span>"; 
        		},
      		});
			/*panel.append("text")
				 .attr("x", 0)
				 .attr("y", 320)
				 .text("Industry")
				 .attr("fill", "gray")
				 .attr("font-size", "20px");*/

		}
		function unpaid(theWage) {
			if(parseFloat(theWage)<=0) {
				return "unpaid";
			} else {
				return("$" + theWage + "/hr");
			}
		}; 
		projectPoints(allData());




		/*function changeYear(year) {
			$(".intern-site").remove();
			$("#panel-svg").empty();
			var year = sumData(year);
			var internSites = svg.selectAll(".intern-site")
		      		   		   .data(year.values.sort(function(a) { return a.values.count; }))
		      		           .enter()
		      		           .append("circle")
		      		           .attr("class", "intern-site")
		      		           .attr("cx", function(d) { return projection(d.values.coordinates)[0]; })
		      		           .attr("cy", function(d) { return projection(d.values.coordinates)[1]; })
		      		           .attr("r", function(d) { return radius(d.values.count); })
		      		           .attr("onclick", function(d) { return "displayData('" + d.key + "',0)" });

		 }*/
		/*$('svg circle').tipsy({ 
        	gravity: 's', 
        	html: true, 
        	title: function() {
          		var d = this.__data__, site = d.key, wage = d.values.medWage, count = d.values.count;
          		return '<span>' + site + '</span><br><span>Median Wage: $' + wage + '/hr</spane><br><span>No. of internships: ' + count + "</span>"; 
        	},
      	});*/

      	$('.industry').tipsy({ 
        	gravity: 's', 
        	html: true, 
        	title: function() {
          		var d = this.__data__, site = d.values.industry;
          		return '<span>' + site + '</span>'; 
        	}
      	});

     

	</script>
	<script src="js/ui.js"></script>
</body>
</html>