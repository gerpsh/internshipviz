<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery-1.11.2.min.js"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="js/internship_main.js"></script>
	<script src='js/jquery.tipsy.js'></script>
	<link rel="stylesheet" type="text/css" href="css/internship.css">
	<link rel="stylesheet" href="css/tipsy.css" type="text/css" />
<head>
<body>
	<script>

		 $(function() {
   			$('a[rel=tipsy]').tipsy({fade: true, gravity: 'n'});
 		 });

		var width = 900,
			height = 600;
		var projection = d3.geo.albersUsa();

		var path = d3.geo.path().projection(projection);
		

		var x = d3.scale.linear()
    			  .domain([0, width])
    			  .range([0, width]);

		var y = d3.scale.linear()
    			  .domain([0, height])
    			  .range([height, 0]);


		/*var zoom = d3.behavior.zoom()
    				 .translate([0, 0])
    				 .scale(1)
                     .scaleExtent([1, 8])
                     .on("zoom", zoom1);*/

        
		var svg = d3.select("body").append("svg")
					.attr("width", width)
					.attr("height", height)
					.attr("id", "map-svg")
					.append("g");
					//.call(d3.behavior.zoom().x(x).y(y).scaleExtent([1, 8]).on("zoom", zoom2));

		var panel = d3.select("body").append("svg")
					  .attr("width", width/4 + 50)
					  .attr("height", height)
					  .attr("id", "panel-svg");

		var features = svg.append("g");	

		/*svg.append("rect")
    	   .attr("class", "overlay")
           .attr("width", width)
           .attr("height", height)
           .call(zoom);*/

        var radius = d3.scale.sqrt()
        			   .domain([2, 199])
        			   .range([3, 10]);

        d3.json("js/us.json", function(error, us) {
  			if (error) return console.error(error);

  			features.append("path")
      				.datum(topojson.feature(us, us.objects.states))
      				.attr("class", "state")
      				.attr("d", path);

  			features.append("path")
      				.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      				.attr("class", "state-border")
      				.attr("d", path)
      				.style("stroke-width", "1.5px");

		});

        //call data synchonously
        var yearOne = sumData(0);

        //console.log(JSON.stringify(yearOne.values));
      	var sites = svg.selectAll(".intern-site")
      		   		   .data(yearOne.values.sort(function(a) { return a.values.count; }))
      		           .enter()
      		           .append("circle")
      		           .attr("class", "intern-site")
      		           .attr("cx", function(d) { return projection(d.values.coordinates)[0]; })
      		           .attr("cy", function(d) { return projection(d.values.coordinates)[1]; })
      		           .attr("r", function(d) { return radius(d.values.count); })
      		           .attr("onclick", function(d) { return "displayDataDiv('" + d.key + "',0)" })
      		           .attr("title", function(d) { return d.key });

       /*function zoom1() {
  			features.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
  			features.select(".state-border").style("stroke-width", 1.5 / d3.event.scale + "px");
  			
		}*/

		/*function zoom2() {
			sites.attr("transform", transform);
		}*/

		d3.select(self.frameElement).style("height", height + "px");

		function transform(n) {
			console.log(n);
  			return "translate(" + x(n[0]) + "," + y(n[1]) + ")";
		}


		function displayDataDiv(location, year) {

			$("#panel-svg").empty();
			theData = industryData(location, year);

			var barX = d3.scale.linear()
						  .domain([0, theData[0].values.count])
						  .range([0, (width/4) - 70]);

			var barHeight = 15;

			var bar = panel.selectAll("g")
						   .data(theData)
						   .enter().append("g")
						   .attr("transform", function(d, i) { return "translate(0, " + i * barHeight + ")"; })
						   .attr("class", "industry");


			rects = bar.append("rect")
			   		   .attr("height", barHeight-1)
			   		   .attr("width", function(d) { return barX(d.values.count) })
			   		   .attr("onmousemove");

			bar.append("text")
			   .attr("x", function(d) { console.log(d) });

			panel.append("text")
				 .attr("x", 0)
				 .attr("y", 320)
				 .text("Industry")
				 .attr("fill", "gray")
				 .attr("font-size", "20px");

		}

		function changeYear(year) {
			$(".intern-site").remove();
			$("#panel-svg").empty();
			var year = sumData(year);
			var internSites = svg.selectAll(".intern-site")
		      		   		   .data(year.values.sort(function(a) { return a.values.count; }))
		      		           .enter()
		      		           .append("circle")
		      		           .attr("class", "intern-site")
		      		           .attr("cx", function(d) { return projection(d.values.coordinates)[0]; })
		      		           .attr("cy", function(d) { return projection(d.values.coordinates)[1]; })
		      		           .attr("r", function(d) { return radius(d.values.count); })
		      		           .attr("onclick", function(d) { return "displayDataDiv('" + d.key + "',0)" });

		 };
		$('svg circle').tipsy({ 
        	gravity: 'w', 
        	html: true, 
        	title: function() {
          		var d = this.__data__, site = d.key;
          		return '<span>' + site + '</span>'; 
        	}
      	});

      	$('.industry').tipsy({ 
        	gravity: 'w', 
        	html: true, 
        	title: function() {
          		var d = this.__data__, site = d.key;
          		return '<span>' + site + '</span>'; 
        	}
      	});

     

		
	</script>
	<input id="year-range" min=0 max=2 type="range" onchange="changeYear($('#year-range').val());"></input>
	<p id='year-label'
</body>
</html>